<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Building effective SIEM correlation rules for threat detection">
    <title>Building SIEM Correlation Rules - Parth Thakar</title>
    <link rel="stylesheet" href="css/style-new.css">
    <style>
        .blog-content {
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .blog-header-full {
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--accent-primary);
        }
        
        .blog-title-full {
            font-size: 2.5rem;
            color: var(--accent-primary);
            margin-bottom: 1rem;
            line-height: 1.2;
        }
        
        .blog-meta-full {
            color: var(--text-secondary);
            font-size: 1rem;
            margin-bottom: 1rem;
        }
        
        .blog-tags-full {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }
        
        .blog-tag-full {
            background: rgba(34, 211, 238, 0.1);
            color: var(--accent-primary);
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.9rem;
            border: 1px solid var(--accent-primary);
        }
        
        .blog-body {
            color: var(--text-primary);
            line-height: 1.8;
            font-size: 1.05rem;
        }
        
        .blog-body h2 {
            color: var(--accent-primary);
            font-size: 1.8rem;
            margin: 2rem 0 1rem 0;
            padding-top: 1rem;
        }
        
        .blog-body h3 {
            color: var(--accent-secondary);
            font-size: 1.4rem;
            margin: 1.5rem 0 1rem 0;
        }
        
        .blog-body p {
            margin-bottom: 1.2rem;
        }
        
        .blog-body code {
            background: rgba(0, 0, 0, 0.5);
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            color: var(--accent-green);
            font-size: 0.95rem;
        }
        
        .blog-body pre {
            background: rgba(0, 0, 0, 0.7);
            padding: 1.5rem;
            border-radius: 8px;
            overflow-x: auto;
            border-left: 4px solid var(--accent-primary);
            margin: 1.5rem 0;
        }
        
        .blog-body pre code {
            background: none;
            padding: 0;
            color: var(--text-primary);
        }
        
        .blog-body ul, .blog-body ol {
            margin-bottom: 1.2rem;
            padding-left: 2rem;
        }
        
        .blog-body li {
            margin-bottom: 0.5rem;
        }
        
        .blog-body strong {
            color: var(--accent-primary);
            font-weight: 600;
        }
        
        .back-link {
            display: inline-block;
            margin-top: 2rem;
            padding: 0.8rem 1.5rem;
            background: rgba(34, 211, 238, 0.1);
            color: var(--accent-primary);
            text-decoration: none;
            border-radius: 5px;
            border: 1px solid var(--accent-primary);
            transition: all 0.3s ease;
        }
        
        .back-link:hover {
            background: var(--accent-primary);
            color: #000;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav>
        <div class="nav-container">
            <a href="index.html" class="logo">Parth Thakar</a>
            <div class="menu-toggle">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <div class="nav-right">
                <ul class="nav-menu">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="about.html">About</a></li>
                    <li><a href="resume.html">Resume</a></li>
                    <li><a href="certifications.html">Certifications</a></li>
                    <li><a href="portfolio.html">Portfolio</a></li>
                    <li><a href="blog.html">Blog</a></li>
                </ul>
                <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
                    <span id="themeIcon">‚òÄÔ∏è</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Blog Content -->
    <div class="blog-content">
        <article>
            <div class="blog-header-full">
                <h1 class="blog-title-full">Building Effective SIEM Correlation Rules for Threat Detection</h1>
                <div class="blog-meta-full">
                    <span>üìÖ December 5, 2024</span> ‚Ä¢ 
                    <span>‚è±Ô∏è 10 min read</span> ‚Ä¢ 
                    <span>üë§ Parth Thakar</span>
                </div>
                <div class="blog-tags-full">
                    <span class="blog-tag-full">SOC</span>
                    <span class="blog-tag-full">SIEM</span>
                    <span class="blog-tag-full">Splunk</span>
                    <span class="blog-tag-full">Blue Team</span>
                </div>
            </div>

            <div class="blog-body">
                <h2>Introduction</h2>
                <p>
                    During my SOC operations internships, I learned that the effectiveness of a Security Operations Center heavily depends on well-crafted correlation rules. A SIEM (Security Information and Event Management) system is only as good as its detection logic. In this article, I'll share practical insights on building correlation rules that detect real threats while minimizing false positives‚Äîa balance that took me months to master.
                </p>

                <h2>Understanding SIEM Correlation</h2>
                <p>
                    SIEM correlation is the process of combining multiple security events to identify patterns that indicate malicious activity. Unlike simple alert rules that trigger on single events, correlation rules analyze relationships between events across time, hosts, users, and data sources.
                </p>
                <p>
                    Think of it like connecting the dots: A single failed login isn't concerning, but 50 failed logins followed by a successful login from an unusual location tells a very different story.
                </p>

                <h2>The Foundation: Understanding Your Data</h2>
                <p>
                    Before writing any correlation rules, you must understand your data sources. During my internship at AWL Agri Business Ltd, I spent the first week simply observing log patterns:
                </p>
                <ul>
                    <li><strong>Windows Event Logs:</strong> Event IDs 4624 (successful logon), 4625 (failed logon), 4672 (admin rights), 4688 (process creation)</li>
                    <li><strong>Firewall Logs:</strong> Connection attempts, blocked traffic, allowed traffic patterns</li>
                    <li><strong>Proxy Logs:</strong> Web traffic, blocked URLs, data transfer volumes</li>
                    <li><strong>EDR/Antivirus Logs:</strong> Malware detections, suspicious behavior, process executions</li>
                    <li><strong>VPN Logs:</strong> Connection attempts, authentication events, user sessions</li>
                </ul>

                <h2>Common SIEM Platforms and Their Syntax</h2>
                <p>
                    I've worked with several SIEM platforms. Here's a quick comparison:
                </p>
                <ul>
                    <li><strong>Splunk:</strong> SPL (Search Processing Language) - Most flexible, powerful statistical operations</li>
                    <li><strong>IBM QRadar:</strong> AQL (Ariel Query Language) - Strong on correlation between different log sources</li>
                    <li><strong>ELK Stack:</strong> Lucene query syntax with Elasticsearch - Open-source, highly customizable</li>
                    <li><strong>Sigma:</strong> Platform-agnostic rule format - Write once, deploy everywhere</li>
                </ul>

                <h2>Building Your First Correlation Rule: Brute Force Detection</h2>
                <p>
                    Let's start with a classic use case‚Äîdetecting brute force attacks. This was one of the first rules I created that significantly reduced investigation time in the SOC.
                </p>

                <h3>The Logic</h3>
                <p>
                    We want to detect when a user account experiences multiple failed login attempts followed by a successful login within a short timeframe. This pattern often indicates credential stuffing or successful brute force attacks.
                </p>

                <h3>Splunk SPL Example</h3>
                <pre><code>index=windows EventCode=4625 OR EventCode=4624
| eval status=if(EventCode=4625, "failed", "success")
| stats count(eval(status="failed")) as failed_count,
        count(eval(status="success")) as success_count,
        values(src_ip) as source_ips
  by user, _time span=5m
| where failed_count > 5 AND success_count > 0
| eval severity="HIGH"
| eval description="Potential brute force attack: ".failed_count." failed attempts followed by successful login"</code></pre>

                <h3>Breaking Down the Rule</h3>
                <ol>
                    <li><strong>Data Selection:</strong> We look at both failed (4625) and successful (4624) Windows logon events</li>
                    <li><strong>Normalization:</strong> Label each event as "failed" or "success" for easier analysis</li>
                    <li><strong>Aggregation:</strong> Group events by user in 5-minute windows</li>
                    <li><strong>Threshold:</strong> Trigger when we see more than 5 failures plus at least 1 success</li>
                    <li><strong>Enrichment:</strong> Add severity and descriptive information for analysts</li>
                </ol>

                <h2>Advanced Rule: Detecting Lateral Movement</h2>
                <p>
                    Lateral movement is when attackers move from one compromised system to another. This is harder to detect but crucial for identifying advanced threats. Here's a rule I developed based on patterns I observed during CTF competitions:
                </p>

                <h3>Splunk SPL Example</h3>
                <pre><code>index=windows EventCode=4624 Logon_Type=3
| stats dc(dest) as unique_targets,
        values(dest) as target_systems,
        count as total_connections
  by src_user, src_host, _time span=10m
| where unique_targets > 5
| eval severity="CRITICAL"
| eval description="Possible lateral movement: User ".src_user." connected to ".unique_targets." different systems in 10 minutes"</code></pre>

                <p>
                    This rule detects when a single user authenticates to multiple systems in a short time‚Äîa common indicator of automated lateral movement tools like PsExec or Mimikatz.
                </p>

                <h2>Using Sigma Rules for Platform Independence</h2>
                <p>
                    Sigma is a generic signature format that can be converted to multiple SIEM platforms. Here's a Sigma rule for detecting suspicious PowerShell usage:
                </p>

                <pre><code>title: Suspicious PowerShell Download Cradle
id: 1f49f2ab-26bc-48b3-96cc-dcffbc93eadf
status: stable
description: Detects PowerShell download cradle patterns commonly used by malware
author: Parth Thakar
date: 2024/12/05
logsource:
    product: windows
    service: powershell
detection:
    selection:
        EventID: 4104
        ScriptBlockText|contains:
            - 'Net.WebClient'
            - 'DownloadString'
            - 'DownloadFile'
            - 'Invoke-WebRequest'
            - 'Invoke-RestMethod'
    condition: selection
falsepositives:
    - Legitimate software updates
    - Administrative scripts
level: high
tags:
    - attack.execution
    - attack.t1059.001</code></pre>

                <p>
                    This Sigma rule can be converted to Splunk, QRadar, or Elasticsearch syntax using the Sigma converter tool.
                </p>

                <h2>Reducing False Positives: The Art of Tuning</h2>
                <p>
                    The biggest challenge in SOC operations isn't detecting threats‚Äîit's avoiding false positives. Here are strategies I've learned:
                </p>

                <h3>1. Baseline Normal Activity</h3>
                <p>
                    Understand what's normal in your environment. For example, backup servers legitimately connect to many systems, which could trigger lateral movement rules.
                </p>
                <pre><code>| where NOT (src_host IN ("backup-srv-01", "monitoring-srv-02"))</code></pre>

                <h3>2. Use Whitelists Carefully</h3>
                <p>
                    Maintain whitelists of known-good applications, IPs, and users, but review them regularly:
                </p>
                <pre><code>| lookup trusted_ips.csv src_ip OUTPUT is_trusted
| where is_trusted != "true"</code></pre>

                <h3>3. Implement Gradual Thresholds</h3>
                <p>
                    Instead of binary detection, use severity levels:
                </p>
                <ul>
                    <li>10-20 failed logins = LOW severity (monitor)</li>
                    <li>20-50 failed logins = MEDIUM severity (investigate)</li>
                    <li>50+ failed logins = HIGH severity (immediate action)</li>
                </ul>

                <h3>4. Time-Based Filtering</h3>
                <p>
                    Some activities are normal during business hours but suspicious at 3 AM:
                </p>
                <pre><code>| eval hour=strftime(_time, "%H")
| eval is_business_hours=if(hour>=9 AND hour<=17, "yes", "no")
| eval severity=if(is_business_hours="no", "HIGH", "MEDIUM")</code></pre>

                <h2>Real-World Detection: Data Exfiltration</h2>
                <p>
                    Detecting data exfiltration requires monitoring unusual data transfer volumes. This rule helped identify a compromised account during my internship:
                </p>

                <pre><code>index=proxy
| stats sum(bytes_out) as total_bytes_out by user, _time span=1h
| eval total_mb=round(total_bytes_out/1024/1024, 2)
| eventstats avg(total_mb) as avg_mb, stdev(total_mb) as stdev_mb
| eval threshold=avg_mb+(stdev_mb*3)
| where total_mb > threshold
| eval severity="HIGH"
| eval description="Unusual data upload detected: ".total_mb."MB (average: ".round(avg_mb,2)."MB)"</code></pre>

                <p>
                    This rule uses statistical analysis to identify outliers‚Äîwhen a user uploads significantly more data than their average (using standard deviation).
                </p>

                <h2>Best Practices from the Trenches</h2>
                <p>
                    After analyzing thousands of alerts across multiple internships, here are my key recommendations:
                </p>

                <ol>
                    <li><strong>Start Simple:</strong> Begin with basic rules and add complexity gradually</li>
                    <li><strong>Document Everything:</strong> Include detection logic, expected false positives, and investigation steps</li>
                    <li><strong>Test Before Deployment:</strong> Run rules in search mode for a week before enabling alerts</li>
                    <li><strong>Version Control:</strong> Keep rule versions in Git to track changes and rollback if needed</li>
                    <li><strong>Regular Reviews:</strong> Schedule monthly reviews of rule effectiveness and false positive rates</li>
                    <li><strong>Collaborate:</strong> Share rules with the community and learn from others' detection logic</li>
                    <li><strong>Align with MITRE ATT&CK:</strong> Tag rules with MITRE techniques for better threat tracking</li>
                    <li><strong>Measure Success:</strong> Track metrics like detection rate, false positive rate, and mean time to detect</li>
                </ol>

                <h2>Integration with Threat Intelligence</h2>
                <p>
                    Correlation rules become more powerful when integrated with threat intelligence feeds. Here's how I implemented IOC (Indicator of Compromise) checking:
                </p>

                <pre><code>index=firewall action=allowed
| lookup threat_intel_ips.csv dest_ip OUTPUT threat_level, threat_description
| where isnotnull(threat_level)
| eval severity=threat_level
| table _time, src_ip, dest_ip, threat_description, threat_level</code></pre>

                <h2>Automation and Orchestration</h2>
                <p>
                    Modern SOC operations require automation. When correlation rules detect threats, they should trigger automated responses:
                </p>
                <ul>
                    <li><strong>Ticket Creation:</strong> Automatically create incidents in your ticketing system</li>
                    <li><strong>Enrichment:</strong> Pull user information, asset data, and threat intel automatically</li>
                    <li><strong>Containment:</strong> For high-confidence detections, trigger automated isolation or blocking</li>
                    <li><strong>Notification:</strong> Alert on-call analysts via email, SMS, or chat platforms</li>
                </ul>

                <h2>Lessons from CTF Competitions</h2>
                <p>
                    My experience in CTF competitions (16th place IIT Roorkee, 200th place AWS √ó SANS) taught me to think like an attacker. When building correlation rules, I ask:
                </p>
                <ul>
                    <li>What would I do to evade this rule?</li>
                    <li>Can I slow down my attack to stay under thresholds?</li>
                    <li>Can I blend malicious activity with legitimate traffic?</li>
                    <li>What artifacts are impossible to hide?</li>
                </ul>
                <p>
                    This adversarial mindset helps build more robust detection rules.
                </p>

                <h2>Conclusion</h2>
                <p>
                    Building effective SIEM correlation rules is both an art and a science. It requires understanding your environment, knowing attacker techniques, and constantly tuning based on real-world feedback. The rules I've shared here are starting points‚Äîadapt them to your specific environment and threats.
                </p>
                <p>
                    Remember: The goal isn't to detect everything, but to detect what matters most to your organization while maintaining a manageable alert volume for your SOC team. Start with high-confidence, high-impact detections, and expand from there.
                </p>

                <h2>Resources</h2>
                <ul>
                    <li>MITRE ATT&CK Framework: <code>https://attack.mitre.org</code></li>
                    <li>Sigma Rule Repository: <code>https://github.com/SigmaHQ/sigma</code></li>
                    <li>Splunk Security Content: <code>https://research.splunk.com</code></li>
                    <li>Elastic Detection Rules: <code>https://github.com/elastic/detection-rules</code></li>
                </ul>

                <a href="blog.html" class="back-link">‚Üê Back to All Posts</a>
            </div>
        </article>
    </div>

    <!-- Footer -->
    <footer>
        <div class="footer-content">
            <p>&copy; 2024 Parth Thakar. All rights reserved. Built with HTML, CSS, and JavaScript.</p>
            <div class="footer-links">
                <a href="about.html">About</a>
                <a href="certifications.html">Certifications</a>
                <a href="blog.html">Blog</a>
            </div>
        </div>
    </footer>

    <script src="js/main-new.js"></script>
</body>
</html>
